def shopapi
def shopui
def website

pipeline {
  options {
    skipStagesAfterUnstable()
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }

  agent {
    kubernetes {
      yamlFile 'build-pod.yaml'
      defaultContainer 'devops-tools'      
    }
  }
  environment {
    SCANNER_HOME = tool 'sonarqube-scanner-4.8.0'
    ORGANIZATION = "opeomotayo"
    PROJECT_NAME = "bookstore"
  }

  stages {
    stage('Clone Bookstore Repository') { 
      steps { 
        script {
          checkout scm
        }
      }
    }

    stage('Build shop-api Image') { 
      steps {
        dir('ci-pipelines/bookstore-ci/shop-api') {
          script {
            shopapi = docker.build("opeomotayo/shop-api")
          }
        }
      }
    }
    stage('SonarQube Analysis for shop-api') {
        steps{
          dir('ci-pipelines/bookstore-ci/shop-api') {
          withSonarQubeEnv('sonarqube-8.9.10') {
            sh '''$SCANNER_HOME/bin/sonar-scanner -Dsonar.organization=$ORGANIZATION \
                  -Dsonar.java.binaries=build/classes/java/ \
                  -Dsonar.projectKey=bookstore-shop-api \
                  -Dsonar.sources=.'''
          }
        }
      }
    }
    stage("Quality Gate for shop-api") {
      steps {
        dir('ci-pipelines/bookstore-ci/shop-api') {
          timeout(time: 60, unit: 'MINUTES') {
            waitForQualityGate abortPipeline: true
          }
        }
      }
    }
    // stage('Run Vulnerability Scan') {
    //   steps {
    //     container('security-tools'){
    //       dir('ci-pipelines/bookstore-ci/shop-api') {
    //         sh "grype opeomotayo/shop-api:$BUILD_NUMBER" //--scope AllLayers --fail-on=critical
    //       }
    //     }
    //   }
    // }
    
    stage('Build shop-ui Image') { 
      steps {
        dir('ci-pipelines/bookstore-ci/shop-ui') {
          script {
            shopui = docker.build("opeomotayo/shop-ui")
          }
        }
      }
    }
    stage('SonarQube Analysis for shop-ui') {
        steps{
          dir('ci-pipelines/bookstore-ci/shop-ui') {
          withSonarQubeEnv('sonarqube-8.9.10') {
            sh '''$SCANNER_HOME/bin/sonar-scanner -Dsonar.organization=$ORGANIZATION \
                  -Dsonar.java.binaries=build/classes/java/ \
                  -Dsonar.projectKey=bookstore-shop-ui \
                  -Dsonar.sources=.'''
          }
        // }
        }
      }
    }
    stage("Quality Gate for shop-ui") {
      steps {
        dir('ci-pipelines/bookstore-ci/shop-ui') {
          timeout(time: 60, unit: 'MINUTES') {
            waitForQualityGate abortPipeline: true
          }
        }
      }
    }
    stage('Build website Image') { 
      steps {
        dir('ci-pipelines/bookstore-ci/website') {
          script {
            website = docker.build("opeomotayo/website")
          }
        }
      }
    }
    stage('SonarQube Analysis for website') {
        steps{
          dir('ci-pipelines/bookstore-ci/website') {
          withSonarQubeEnv('sonarqube-8.9.10') {
            sh '''$SCANNER_HOME/bin/sonar-scanner -Dsonar.organization=$ORGANIZATION \
                  -Dsonar.java.binaries=build/classes/java/ \
                  -Dsonar.projectKey=bookstore-website \
                  -Dsonar.sources=.'''
          }
        }
      }
    }
    stage("Quality Gate for website") {
      steps {
        dir('ci-pipelines/bookstore-ci/website') {
          timeout(time: 60, unit: 'MINUTES') {
            waitForQualityGate abortPipeline: true
          }
        }
      }
    }

    stage('Publish to Nexus') {
        steps { 
            script {  
                if (currentBuild.result == null || currentBuild.result == 'SUCCESS') {     
                  docker.withRegistry('https://registry.hub.docker.com', 'dockerhub-creds') {
                    shopapi.push("${env.BUILD_NUMBER}")
                    shopui.push("${env.BUILD_NUMBER}")
                    website.push("${env.BUILD_NUMBER}")
                  }
                }
            }
        }
    }
    
    stage('Trigger CD Job') {
      steps { 
        script {  
          sh "printenv"
          echo "triggering the pipeline that updates deployment image tag"
          // paramAValue = "paramAValue"
          // paramBValue = "paramBValue"
          //  build job: 'html-blog-cd', wait: false, parameters: [string(name: 'HELLO', value: "${env.BUILD_NUMBER}")]
          // build job: 'downstream-freestyle', parameters: [[$class: 'StringParameterValue', name: 'ParamA', value: paramAValue], [$class: 'StringParameterValue', name: 'ParamB', value: paramBValue]]
          def job = build job: 'bookstore-cd', parameters: [[$class: 'StringParameterValue', name: 'DOCKERTAG', value: "${env.BUILD_NUMBER}"]]
        }
      }    
    }
  }
}
